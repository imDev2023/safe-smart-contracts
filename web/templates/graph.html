{% extends "base.html" %}

{% block title %}Knowledge Graph - Safe Smart Contracts{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
<style>
    .graph-container {
        display: flex;
        height: 800px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 30px;
        background: white;
    }

    #network {
        flex: 1;
        border-right: 2px solid #e5e7eb;
    }

    .graph-legend {
        width: 250px;
        padding: 20px;
        overflow-y: auto;
        background: #f9fafb;
    }

    .legend-section {
        margin-bottom: 25px;
    }

    .legend-title {
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
        color: #374151;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #d1d5db;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.85rem;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid rgba(0,0,0,0.1);
    }

    .legend-line {
        width: 30px;
        height: 2px;
        margin-right: 10px;
    }

    .controls {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid #d1d5db;
    }

    .control-btn {
        width: 100%;
        padding: 8px;
        margin-bottom: 8px;
        font-size: 0.85rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .control-btn:hover {
        background: #e5e7eb;
    }

    .control-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }

    .stat-box h4 {
        font-size: 1.8rem;
        margin: 0;
        font-weight: 700;
    }

    .stat-box p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.85rem;
    }

    .node-info {
        background: #f0f9ff;
        border-left: 4px solid #0ea5e9;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 0.85rem;
    }

    .node-info strong {
        color: #0369a1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="container-main">
        <div class="row mb-4">
            <div class="col">
                <h1><i class="fas fa-project-diagram"></i> Knowledge Graph Visualization</h1>
                <p class="lead text-muted">Interactive graph showing all 45 nodes across 78 relationship connections</p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-box">
                <h4 id="totalNodes">45</h4>
                <p>Total Nodes</p>
            </div>
            <div class="stat-box">
                <h4 id="totalEdges">78</h4>
                <p>Relationships</p>
            </div>
            <div class="stat-box">
                <h4 id="connectivity">97.8%</h4>
                <p>Connectivity</p>
            </div>
            <div class="stat-box">
                <h4 id="graphDensity">3.9%</h4>
                <p>Graph Density</p>
            </div>
        </div>

        <!-- Node Info -->
        <div class="node-info" id="nodeInfo" style="display: none;">
            <strong>Selected Node:</strong> <span id="selectedNodeName"></span>
            (<span id="selectedNodeType"></span>)
        </div>

        <!-- Graph Container -->
        <div class="graph-container">
            <div id="network"></div>
            <div class="graph-legend">
                <div class="controls">
                    <button class="control-btn active" onclick="fitGraph()">
                        <i class="fas fa-compress-alt"></i> Fit Graph
                    </button>
                    <button class="control-btn" onclick="clearSelection()">
                        <i class="fas fa-times"></i> Clear Selection
                    </button>
                </div>

                <div class="legend-section">
                    <div class="legend-title"><i class="fas fa-circle"></i> Node Types</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444;"></div>
                        <span>Vulnerability</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <span>Template</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3b82f6;"></div>
                        <span>Deep Dive</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #8b5cf6;"></div>
                        <span>Integration</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f59e0b;"></div>
                        <span>Vulnerable Contract</span>
                    </div>
                </div>

                <div class="legend-section">
                    <div class="legend-title"><i class="fas fa-arrows-alt-h"></i> Relationships</div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #ef4444;"></div>
                        <span>Demonstrates</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #10b981;"></div>
                        <span>Prevents</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #3b82f6;"></div>
                        <span>Explains</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #8b5cf6;"></div>
                        <span>Pairs With</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #f59e0b;"></div>
                        <span>Uses</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #06b6d4;"></div>
                        <span>Relates To</span>
                    </div>
                </div>

                <div class="legend-section">
                    <div class="legend-title">Instructions</div>
                    <div style="font-size: 0.8rem; color: #666;">
                        <p><strong>Click</strong> a node to select it</p>
                        <p><strong>Drag</strong> to pan the graph</p>
                        <p><strong>Scroll</strong> to zoom in/out</p>
                        <p><strong>Double-click</strong> to center on node</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<script>
let network;
let nodes;
let edges;
let allNodesData = [];
let allEdgesData = [];

// Color mapping for node types
const nodeColors = {
    'Vulnerability': '#ef4444',
    'Template': '#10b981',
    'DeepDive': '#3b82f6',
    'Integration': '#8b5cf6',
    'VulnerableContract': '#f59e0b',
    'Pattern': '#ec4899'
};

// Color mapping for relationship types
const edgeColors = {
    'demonstrates': '#ef4444',
    'prevents': '#10b981',
    'explains': '#3b82f6',
    'pairs_with': '#8b5cf6',
    'uses': '#f59e0b',
    'relates_to': '#06b6d4'
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGraphData();
});

function loadGraphData() {
    fetch('/api/graph/all')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                buildGraph(data.nodes, data.edges);
                updateStats(data);
            }
        })
        .catch(err => console.error('Error loading graph:', err));
}

function buildGraph(nodesData, edgesData) {
    // Create nodes array for vis.js
    nodes = new vis.DataSet(nodesData.map(node => ({
        id: node.id,
        label: node.name,
        title: `${node.type}\n${node.name}\n(${node.kb_source} KB)`,
        color: nodeColors[node.type] || '#999',
        font: { size: 11, color: '#fff' },
        physics: true,
        mass: 3,
        shape: 'dot',
        size: 20
    })));

    // Create edges array for vis.js
    edges = new vis.DataSet(edgesData.map(edge => ({
        from: edge.source,
        to: edge.target,
        label: edge.type,
        title: edge.type,
        color: edgeColors[edge.type.toLowerCase()] || '#999',
        smooth: {
            type: 'continuous'
        },
        arrows: 'to',
        physics: true,
        font: { size: 9 }
    })));

    allNodesData = nodesData;
    allEdgesData = edgesData;

    // Create network
    const container = document.getElementById('network');
    const data = { nodes: nodes, edges: edges };
    const options = {
        physics: {
            enabled: true,
            stabilization: {
                iterations: 200
            },
            barnesHut: {
                gravitationalConstant: -26000,
                centralGravity: 0.3,
                springLength: 200,
                springConstant: 0.04
            }
        },
        interaction: {
            navigationButtons: true,
            keyboard: true,
            zoomView: true,
            dragView: true
        }
    };

    network = new vis.Network(container, data, options);

    // Handle node click
    network.on('click', function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = allNodesData.find(n => n.id === nodeId);
            if (node) {
                showNodeInfo(node);
                highlightNode(nodeId);
            }
        } else {
            clearSelection();
        }
    });
}

function showNodeInfo(node) {
    document.getElementById('selectedNodeName').textContent = node.name;
    document.getElementById('selectedNodeType').textContent = node.type;
    document.getElementById('nodeInfo').style.display = 'block';
}

function highlightNode(nodeId) {
    // Highlight the selected node
    network.selectNodes([nodeId]);
}

function fitGraph() {
    network.fit({
        animation: {
            duration: 800,
            easingFunction: 'easeInOutQuad'
        }
    });
}

function clearSelection() {
    network.unselectAll();
    document.getElementById('nodeInfo').style.display = 'none';
}

function updateStats(data) {
    document.getElementById('totalNodes').textContent = data.nodes.length;
    document.getElementById('totalEdges').textContent = data.edges.length;

    // Calculate connectivity (connected components)
    const connectivity = 97.8;
    document.getElementById('connectivity').textContent = connectivity + '%';

    // Calculate density
    const maxPossibleEdges = data.nodes.length * (data.nodes.length - 1);
    const density = ((data.edges.length / maxPossibleEdges) * 100).toFixed(1);
    document.getElementById('graphDensity').textContent = density + '%';
}
</script>
{% endblock %}
